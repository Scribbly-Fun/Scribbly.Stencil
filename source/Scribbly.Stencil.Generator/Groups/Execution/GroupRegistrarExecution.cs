using System.Collections.Immutable;
using System.Text;
using Microsoft.CodeAnalysis;
using Scribbly.Stencil.Endpoints.Context;

namespace Scribbly.Stencil.Groups;

public class GroupRegistrarExecution
{
    public static void Generate(SourceProductionContext context, ImmutableArray<TargetGroupCaptureContext> groups)
    {
        if (groups.IsDefaultOrEmpty)
            return;

        var sb = new StringBuilder($"""

                                    // <auto-generated/> @{DateTime.UtcNow}
                                    #nullable enable

                                    using System;
                                    using Microsoft.AspNetCore.Builder;
                                    using Microsoft.AspNetCore.Http;
                                    using Microsoft.AspNetCore.Mvc;
                                    using Microsoft.AspNetCore.Routing;

                                    // 
                                    """);

        foreach (var group in groups)
        {
            sb.AppendLine();
            sb.Append("//").Append(group.Namespace).Append(group.RoutePrefix).Append('-').Append(group.TypeName).Append('-').Append(group.MemberOf);
            sb.AppendLine();
        }

        context.AddSource($"Scribbly.Stencil.GroupRegistry.g.cs", sb.ToString());
    }
}